# Документация: архитектура и workflow проекта

## 1. Назначение

Сервис выступает прослойкой между несколькими внешними системами:

- **MQTT** — приём и публикация состояний устройств (в т.ч. топики вида «устройство/контрол»).
- **Яндекс Алиса (Smart Home)** — отдача списка устройств и выполнение команд пользователя.
- **Яндекс Push** — доставка обновлений состояний устройств в приложение Алисы.
- **Telegram** — отправка сообщений.
- **Локальная БД** — хранение телеметрии, пользователей Алисы и Telegram.

Виртуальные устройства задаются схемой при старте; их состояния синхронизируются между MQTT, памятью, БД и Алисой.

---

## 2. Архитектура

Используется слоёная архитектура с четырьмя уровнями:

- **Ядро (домен)** — сущности, типы данных, перечисления. Без зависимостей от остальных частей.
- **Слой приложения** — сценарии использования, контракты (интерфейсы) для репозиториев и внешних сервисов. Зависит только от ядра.
- **Слой инфраструктуры** — реализация БД, MQTT, Telegram, API Яндекса, метрик, хранилища виртуальных устройств. Реализует контракты из слоя приложения.
- **Точка входа (хост)** — HTTP API, фоновые задачи, middleware, конфигурация и регистрация сервисов. Зависит от приложения, ядра и инфраструктуры.

Зависимости направлены внутрь: от хоста к приложению и инфраструктуре, от них — к ядру.

---

## 3. Верхнеуровневые абстракции

**Домен**

- Виртуальное устройство и его контролы (имя, тип, текущее значение, признак «отправлять в Алису»).
- Типы контролов: переключатели, позиция, шторы, термостат, датчики и т.п.
- Телеметрия (устройство, контрол, значение, время).
- Пользователи Алисы и Telegram.
- Модели запросов/ответов и push для Алисы.
- Сообщение очереди (топик + payload) и параметры подключения к очереди.

**Слой приложения**

- Сценарии: обновление состояния устройства по данным из очереди; получение списка устройств и состояния для Алисы; выполнение команд Алисы; управление пользователями и отправка сообщений в Telegram.
- Обработчики входящих сообщений очереди: подписка на топик устройств и передача каждого сообщения в сценарий обновления состояния.
- Обработчики уведомлений: отправка обновлений в Алису (push), запись телеметрии в БД, обновление метрик по числовым значениям.
- Контракты: репозитории (телеметрия, пользователи Алисы, пользователи Telegram, виртуальные устройства), сервис очереди, сервис push, сервис Telegram, метрики.

**Инфраструктура**

- База данных: миграции, репозитории телеметрии и пользователей.
- Хранилище виртуальных устройств: загрузка схемы при старте, in-memory состояние, восстановление из телеметрии.
- Клиент очереди: подключение, подписка на топики, публикация сообщений, переподключение.
- Интеграции: Telegram, API Яндекса (push, информация о пользователе), метрики.

**Хост**

- HTTP: эндпоинты для Алисы (устройства, запрос состояния, выполнение действий, отвязка пользователя, проверка здоровья), эндпоинты хранилища (чтение телеметрии и пользователей), эндпоинт отправки сообщения в Telegram.
- Фоновые задачи: последовательная инициализация компонентов при старте; подписка на топик устройств и вызов обработчика каждого сообщения.
- Сквозная функциональность: логирование запросов, обработка исключений.

---

## 4. Workflow

**Старт приложения**

1. Загружается конфигурация и настраивается логирование.
2. Регистрируются сервисы: БД, очередь, Telegram, Яндекс, хранилище устройств, метрики, сценарии и обработчики.
3. Запускается фоновая инициализация: миграции БД, затем загрузка схемы устройств и восстановление их состояний из телеметрии. После этого хранилище устройств доступно для запросов.
4. Запускается подписка на топик состояний устройств в очереди; каждое сообщение передаётся в обработчик.

**Сообщение из очереди → обновление состояния**

1. Приходит сообщение: топик (устройство + контрол), payload — значение.
2. Обработчик очереди вызывает сценарий обновления состояния устройства.
3. Сценарий находит устройство и контрол в хранилище; при изменении значения обновляет его в памяти и отправляет уведомление «обновление в Алису».
4. Одновременно отправляется уведомление «значение изменено» (устройство, контрол, значение).
5. Обработчики уведомлений: для каждого пользователя Алисы — push с новым состоянием; запись телеметрии в БД; при числовом значении — обновление метрики.

В итоге одно сообщение из очереди обновляет память, БД, метрики и при необходимости — устройства в Алисе.

**Запросы Алисы**

- Запрос списка устройств / состояния: данные берутся из хранилища виртуальных устройств, приводятся к формату Алисы и возвращаются.
- Выполнение команды: по идентификаторам и типу контрола определяется целевое устройство и контрол, значение обновляется в памяти и публикуется в очередь (управление физическими устройствами выполняет уже внешняя система по MQTT).

**Остальные сценарии**

- Чтение телеметрии и пользователей — прямой запрос к репозиториям.
- Отправка в Telegram и отвязка пользователя Алисы — отдельные сценарии, вызываемые с соответствующих эндпоинтов.

---

## 5. Итог

Сервис выступает прослойкой между MQTT, Алисой, Telegram и локальной БД: хранит схему и состояние виртуальных устройств, синхронизирует их с очередью и телеметрией и обслуживает API Алисы и вспомогательные HTTP-эндпоинты. Детали реализации (конкретные библиотеки, имена сборок и классов) в этой документации не приводятся — остаются только назначение, слои, абстракции и общий поток данных.
